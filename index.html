<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="img/favicon.ico" />
    <title>Description - dd-transfer-to-vault</title>
    <link rel="stylesheet" href="css/theme.css" />
    <link rel="stylesheet" href="css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Description";
        var mkdocs_page_input_path = "index.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="." class="icon icon-home"> dd-transfer-to-vault
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="./search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Manual</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Description</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#purpose">Purpose</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#interfaces">Interfaces</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#provided-interfaces">Provided interfaces</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#inbox">Inbox</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#command-api">Command API</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#admin-console">Admin console</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#consumed-interfaces">Consumed interfaces</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#validate-bagpack-api">Validate Bagpack API</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#extract-metadata-inbox">Extract metadata inbox</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#data-vault-catalog">Data Vault Catalog</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#nbn-database">NBN Database</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#data-vault-import-inbox">Data Vault import inbox</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#processing">Processing</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#inbox_1">Inbox</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#validation">Validation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#metadata-extraction">Metadata extraction</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#nbn-registration">NBN registration</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#transfer-to-vault">Transfer to vault</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="installation/">Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="config/">Configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="to-api/">API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="context/">Context</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Development</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="dev/">Overview</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href=".">dd-transfer-to-vault</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Manual</li>
      <li class="breadcrumb-item active">Description</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/DANS-KNAW/dd-transfer-to-vault/edit/master/docs/index.md">Edit on DANS-KNAW/dd-transfer-to-vault</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="dd-transfer-to-vault">dd-transfer-to-vault<a class="headerlink" href="#dd-transfer-to-vault" title="Permanent link">&para;</a></h1>
<p>Processes dataset version exports for inclusion in the DANS Data Vault</p>
<h2 id="purpose">Purpose<a class="headerlink" href="#purpose" title="Permanent link">&para;</a></h2>
<p>This service is responsible for taking dataset version exports (DVE for short), cataloging them and transferring them to the DANS data vault. If the dataset
version export is the first version of a dataset, an <a href="https://www.kb.nl/en/about-us/services/nbn-agency-nl" target="_blank">NBN persistent identifier</a> is minted for the dataset and registered in the NBN database.</p>
<h2 id="interfaces">Interfaces<a class="headerlink" href="#interfaces" title="Permanent link">&para;</a></h2>
<p>This service has the following interfaces:</p>
<p><img alt="Interfaces" src="img/overview.png" /></p>
<h3 id="provided-interfaces">Provided interfaces<a class="headerlink" href="#provided-interfaces" title="Permanent link">&para;</a></h3>
<h4 id="inbox">Inbox<a class="headerlink" href="#inbox" title="Permanent link">&para;</a></h4>
<ul>
<li><em>Protocol type</em>: Shared filesystem</li>
<li><em>Internal or external</em>: <strong>internal</strong></li>
<li><em>Purpose</em>: to receive DVEs from the Data Stations and other services</li>
</ul>
<h4 id="command-api">Command API<a class="headerlink" href="#command-api" title="Permanent link">&para;</a></h4>
<ul>
<li><em>Protocol type</em>: HTTP</li>
<li><em>Internal or external</em>: <strong>internal</strong></li>
<li><em>Purpose</em>: to interact with the service programmatically</li>
</ul>
<h4 id="admin-console">Admin console<a class="headerlink" href="#admin-console" title="Permanent link">&para;</a></h4>
<ul>
<li><em>Protocol type</em>: HTTP</li>
<li><em>Internal or external</em>: <strong>internal</strong></li>
<li><em>Purpose</em>: application monitoring and management</li>
</ul>
<h3 id="consumed-interfaces">Consumed interfaces<a class="headerlink" href="#consumed-interfaces" title="Permanent link">&para;</a></h3>
<h4 id="validate-bagpack-api">Validate Bagpack API<a class="headerlink" href="#validate-bagpack-api" title="Permanent link">&para;</a></h4>
<ul>
<li><em>Protocol type</em>: HTTP</li>
<li><em>Internal or external</em>: <strong>internal</strong></li>
<li><em>Purpose</em>: to validate that the DVE is a valid bagpack</li>
</ul>
<h4 id="extract-metadata-inbox">Extract metadata inbox<a class="headerlink" href="#extract-metadata-inbox" title="Permanent link">&para;</a></h4>
<ul>
<li><em>Protocol type</em>: Shared filesystem</li>
<li><em>Internal or external</em>: <strong>internal</strong></li>
<li><em>Purpose</em>: to let the Validate Bagpack service access the DVE for validation</li>
</ul>
<h4 id="data-vault-catalog">Data Vault Catalog<a class="headerlink" href="#data-vault-catalog" title="Permanent link">&para;</a></h4>
<ul>
<li><em>Protocol type</em>: HTTP</li>
<li><em>Internal or external</em>: <strong>internal</strong></li>
<li><em>Purpose</em>: to maintain information about the datasets and their versions that are stored in the DANS data vault</li>
</ul>
<h4 id="nbn-database">NBN Database<a class="headerlink" href="#nbn-database" title="Permanent link">&para;</a></h4>
<ul>
<li><em>Protocol type</em>: HTTP</li>
<li><em>Internal or external</em>: <strong>external</strong></li>
<li><em>Purpose</em>: to mint and register NBN persistent identifiers for datasets</li>
</ul>
<h4 id="data-vault-import-inbox">Data Vault import inbox<a class="headerlink" href="#data-vault-import-inbox" title="Permanent link">&para;</a></h4>
<ul>
<li><em>Protocol type</em>: Shared filesystem</li>
<li><em>Internal or external</em>: <strong>internal</strong></li>
<li><em>Purpose</em>: to import DVEs into the DANS data vault</li>
</ul>
<h6 id="data-vault-api">Data Vault API<a class="headerlink" href="#data-vault-api" title="Permanent link">&para;</a></h6>
<ul>
<li><em>Protocol type</em>: HTTP</li>
<li><em>Internal or external</em>: <strong>internal</strong></li>
<li><em>Purpose</em>: to issue commands to the DANS data vault and retrieve information from it</li>
</ul>
<h2 id="processing">Processing<a class="headerlink" href="#processing" title="Permanent link">&para;</a></h2>
<p>This service is best viewed as a processing pipeline for DVEs. It connects a source that produces DVEs to a target DANS
<a href="https://dans-knaw.github.io/dans-datastation-architecture/data-vault-storage-root/" target="_blank">Data Vault Storage Root</a>, which stores the DVEs as OCFL object versions. A source can be a Data Station or a Vault as a Service client. The
service takes care of cataloging the DVEs and ensuring that the dataset is resolvable via the NBN persistent identifier. It attempts to do this in an efficient
way, by processing multiple DVEs in parallel, while ensuring that the order of the dataset version exports is preserved. Furthermore, the service will attempt
to resume processing of DVEs that were left unfinished in the event of a crash or restart.</p>
<h3 id="inbox_1">Inbox<a class="headerlink" href="#inbox_1" title="Permanent link">&para;</a></h3>
<p>The inbox is a directory into which DVEs are dropped. When a DVE is detected the inbox will determine what the NBN of the target dataset is. DVEs for the same
dataset version are processed in order, but DVEs for different dataset versions can be processed in parallel, except for the transfer to the vault (see below).</p>
<h3 id="validation">Validation<a class="headerlink" href="#validation" title="Permanent link">&para;</a></h3>
<p>The first step in the processing pipeline is to validate the DVE. Currently, the only layout that is supported is the <a href="http://doi.org/10.15497/RDA00025" target="_blank">bagpack</a> layout. If the
DVE is not a bagpack, it will be rejected. Any other DVEs for the same dataset version will be blocked from processing until the problem is resolved.</p>
<h3 id="metadata-extraction">Metadata extraction<a class="headerlink" href="#metadata-extraction" title="Permanent link">&para;</a></h3>
<p>The next step is to extract the metadata from the DVE and to create or update the dataset version in the DANS data vault catalog. The main source of metadata is
the <code>metadata/oai-ore.jsonld</code> file in the DVE.</p>
<h3 id="nbn-registration">NBN registration<a class="headerlink" href="#nbn-registration" title="Permanent link">&para;</a></h3>
<p>After the Vault Catalog has been updated, the NBN persistent identifier is minted and scheduled for registration in the NBN database. This is done in a separate
background thread which uses a database table as a queue, so that the registration can be retried in case of a restart or crash.</p>
<h3 id="transfer-to-vault">Transfer to vault<a class="headerlink" href="#transfer-to-vault" title="Permanent link">&para;</a></h3>
<p>Finally, the DVE is extracted to the current DANS data vault import inbox batch for this instance of <code>dd-transfer-to-vault</code>. If the size of the batch exceeds a
configured threshold, the service will issue a command to the DANS data vault to import the current batch of DVEs. This step is executed on a single dedicated
thread, so that determining the size of the batch can be done reliably.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="installation/" class="btn btn-neutral float-right" title="Installation">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/DANS-KNAW/dd-transfer-to-vault" class="fa fa-code-fork" style="color: #fcfcfc"> DANS-KNAW/dd-transfer-to-vault</a>
        </span>
    
    
    
      <span><a href="installation/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="js/jquery-3.6.0.min.js"></script>
    <script>var base_url = ".";</script>
    <script src="js/theme_extra.js"></script>
    <script src="js/theme.js"></script>
      <script src="search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
